<!--
  ~ Copyright  (c) 2016-2017, Hortonworks Inc.  All rights reserved.
  ~
  ~ Except as expressly permitted in a written agreement between you or your company
  ~ and Hortonworks, Inc. or an authorized affiliate or partner thereof, any use,
  ~ reproduction, modification, redistribution, sharing, lending or other exploitation
  ~ of all or any part of the contents of this software is strictly prohibited.
  -->

<dlm-table #table
  [rowDetailHeight]="550"
  [rowDetailTemplate]="rowDetailRef"
  [theme]="tableTheme"
  [columns]="columns"
  [columnMode]="columnMode"
  [rows]="policies">
</dlm-table>

<dlm-icon-column></dlm-icon-column>
<dlm-status-column [showText]="false"></dlm-status-column>
<dlm-policy-info
  [expandedRows]="tableComponent.expandedRows"
  [activeContent]="activeContentType"
  (nameClick)="toggleRowDetail($event, policyContent.Files)">
</dlm-policy-info>

<ng-template #durationCell let-seconds="value" let-policy="row">
  <dlm-duration-column [duration]="seconds"></dlm-duration-column>
</ng-template>

<ng-template #verbStatusCellTemplate let-value="value">
  {{value | statusFmt}}
</ng-template>

<ng-template #clusterCellTemplate let-value="value">
  <div class="cluster-name">{{value.name}}</div>
  <div class="datacenter-name">{{value.dataCenter}}</div>
</ng-template>

<ng-template #iconCellTemplate>
  <span class="fa fa-arrow-right" aria-hidden="true"></span>
</ng-template>

<ng-template #prevJobs let-row="row">
  <span class="actionable" qe-attr="policy-jobs" (click)="toggleRowDetail(row, policyContent.Jobs)">
    <dlm-prev-jobs [policy]="row"></dlm-prev-jobs>
    <span [ngClass]="{'text-primary': true, 'fa': true, 'fa-caret-up': isPrevJobsActive(row.id), 'fa-caret-down': !isPrevJobsActive(row.id)}">
    </span>
  </span>
</ng-template>

<ng-template #lastGoodCell let-time="value">
  <span *ngIf="time; else noData" [tooltip]="time | fmtTz | amDateFormat:'YYYY-MMM-DD, HH:mm:ss'">
    {{time | fmtTz | amTimeAgo}}
  </span>
  <ng-template #noData>
    n/a
  </ng-template>
</ng-template>

<ng-template let-row="row" ngx-datatable-row-detail-template #rowDetailRef>
  <dlm-policy-details
    [contentType]="activeContentType"
    [policy]="row"
    [jobs]="filteredJobs$ | async"
    [sourceCluster]="sourceCluster"
    [hdfsRootPath]="hdfsRootPath"
    [policyDatabase]="policyDatabase$ | async"
    [jobsSort]="getJobsSortForRow(row.id)"
    [jobsPage]="getJobsPageForRow(row.id)"
    [jobsActiveActions]="getJobsActiveActionsForRow(row.id)"
    [fileBrowserPage]="getFilesPageForRow(row.id)"
    (onPageChangeFiles)="handleFilesPageChange($event, row.id)"
    (onOpenDirectory)="handleOnOpenDirectory($event)"
    (onSortJobs)="handleOnSortJobs($event, row.id)"
    (onSelectActionJobs)="handleOnSelectActionJobs($event, row.id)"
    (onPageChangeJobs)="handleJobsPageChange($event, row.id)"
    (abortJobAction)="abortJobAction($event)"
    (rerunJobAction)="rerunJobAction($event)"
  ></dlm-policy-details>
</ng-template>

<ng-template #pathCell let-row="row" let-value="value">
  <span [tooltip]="value">{{value}}</span>
</ng-template>

<ng-template #actionsCell let-row="row">
  <dlm-policy-actions
    qe-attr="policy-actions"
    [rowId]="row.id"
    [policy]="row"
    [isOpen]="shouldShowAction(row.id)"
    [policyActions]="rowActions"
    (openChange)="handleActionOpenChange($event)"
    (handler)="handleSelectedAction($event)">
  </dlm-policy-actions>
</ng-template>
