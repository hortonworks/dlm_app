<!--
  ~ Copyright  (c) 2016-2017, Hortonworks Inc.  All rights reserved.
  ~
  ~ Except as expressly permitted in a written agreement between you or your company
  ~ and Hortonworks, Inc. or an authorized affiliate or partner thereof, any use,
  ~ reproduction, modification, redistribution, sharing, lending or other exploitation
  ~ of all or any part of the contents of this software is strictly prohibited.
  -->

<div class="form-container">
  <form class="basic-form policy-form" [formGroup]="policyForm" (ngSubmit)="handleSubmit(policyForm)">
    <div class="container-fluid">
      <div class="row">
        <div class="form-section col-xs-12">
          <div class="form-section-title actionable" (click)="toggleSection('general')">
            {{'page.policies.form.sections.general' | translate}}
            <div class="pull-right">
              <i class="fa text-primary" [ngClass]="{'fa-chevron-down': sectionCollapsedMap.general, 'fa-chevron-up': !sectionCollapsedMap.general}"></i>
            </div>
            <div class="clearfix"></div>
          </div>
          <fieldset formGroupName="general" [collapse]="sectionCollapsedMap.general">

            <!-- POLICY NAME -->
            <dlm-form-field
              [label]="'page.policies.form.fields.policy_name' | translate"
              [required]="true"
              [maxLengthValue]="64">
              <input
                type="text"
                class="form-control"
                qe-attr="policy-name"
                formField
                formControlName="name" />
              <dlm-field-error *ngIf="policyForm.get('general.name').hasError('nameValidator')">
                {{'forms.validation_errors.namePattern' | translate}}
              </dlm-field-error>
            </dlm-form-field>
            <!-- POLICY NAME END -->

            <!-- POLICY DESCRIPTION -->
            <dlm-form-field
              [label]="'page.policies.form.fields.policy_description' | translate"
              [maxLengthValue]="512">
              <textarea
                rows="4"
                class="form-control"
                qe-attr="policy-description"
                formField
                formControlName="description">
              </textarea>
            </dlm-form-field>
            <!-- POLICY DESCRIPTION END -->

            <!-- POLICY TYPE -->
            <div class="form-group">
              <div class="row">
                <label class="col-xs-6">
                  {{'page.policies.form.fields.service' | translate}}
                </label>
              </div>
              <div class="row">
                <div class="col-xs-6">
                  <dlm-radio-button
                    qe-attr="policy-type"
                    [items]="storageTypes"
                    formControlName="type">
                  </dlm-radio-button>
                </div>
              </div>
              <div class="row" *ngIf="isHDFSPolicy()">
                <label class="col-xs-12">
                  <dlm-help-link
                    id="enable_snapshot"
                    [linkTo]="'page.policies.form.help.snapshot_url' | translate"
                    [linkText]="'page.policies.form.help.snapshot_text'">
                  </dlm-help-link>
                </label>
              </div>
            </div>
            <!-- POLICY TYPE END -->

            <div class="form-group">
              <!-- SOURCE -->
              <div class="row">
                <fieldset formGroupName="source">
                <div class="col-xs-12">
                  <div class="row">
                    <!-- SOURCE TYPE -->
                    <div class="col-xs-4">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.source_type' | translate"
                        [fieldClass]="'col-xs-12'"
                        [errorClass]=""
                        [required]="true">
                        <dlm-select-field
                          qe-attr="policy-source-type"
                          formField
                          formControlName="type"
                          [options]="sourceTypes"
                          [value]="sourceType">
                        </dlm-select-field>
                      </dlm-form-field>
                    </div>
                    <!-- SOURCE TYPE END -->
                    <!-- SOURCE CLUSTER -->
                    <div class="col-xs-4" *ngIf="policyForm.get('general.source.type').value === CLUSTER">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.sourceCluster.self' | translate"
                        [fieldClass]="'col-xs-12'"
                        [errorClass]=""
                        [required]="true">
                        <dlm-select-field
                          qe-attr="policy-source-cluster"
                          formField
                          formControlName="cluster"
                          [options]="sourceClusters"
                          [value]="sourceCluster">
                        </dlm-select-field>
                      </dlm-form-field>
                    </div>
                    <!-- SOURCE CLUSTER END -->
                    <!-- SOURCE CLOUD ACCOUNT -->
                    <div class="col-xs-4"
                         *ngIf="policyForm.get('general.source.type').value === S3">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.s3.account' | translate"
                        [required]="true"
                        [fieldClass]="'col-xs-12'"
                        [errorClass]="">
                        <dlm-select-field
                          qe-attr="source-cloud-account"
                          formField
                          formControlName="cloudAccount"
                          [options]="sourceCloudAccounts"
                          [value]="sourceCloudAccount">
                        </dlm-select-field>
                      </dlm-form-field>
                    </div>
                    <!-- SOURCE CLOUD ACCOUNT END -->
                    <!-- SOURCE S3 ENDPOINT -->
                    <div class="col-xs-4" *ngIf="policyForm.get('general.source.cloudAccount').value && policyForm.get('general.source.type').value === S3">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.s3.endpoint' | translate"
                        [errorClass]="'col-xs-12'"
                        [fieldClass]="'col-xs-12'"
                        [required]="true">
                        <div class="input-group">
                          <div class="input-group-addon">{{S3}}</div>
                          <input
                            type="text"
                            class="form-control"
                            qe-attr="sourceS3endpoint"
                            formField
                            formControlName="s3endpoint"/>
                        </div>
                      </dlm-form-field>
                      <button type="button" class="btn btn-success pull-right">{{"page.policies.form.validateBtn" | translate}}</button>
                    </div>
                    <!-- SOURCE S3 ENDPOINT END -->
                  </div>
                </div>
                </fieldset>
              </div>
              <!-- SOURCE END -->

              <!-- DESTINATION -->
              <div class="row">
                <fieldset formGroupName="destination">
                <div class="col-xs-12">
                  <div class="row">
                    <!-- DESTINATION TYPE -->
                    <div class="col-xs-4">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.destination_type' | translate"
                        [fieldClass]="'col-xs-12'"
                        [errorClass]=""
                        [required]="true">
                        <dlm-select-field
                          qe-attr="policy-destination-type"
                          formField
                          formControlName="type"
                          [options]="destinationTypes"
                          [value]="destinationType">
                        </dlm-select-field>
                      </dlm-form-field>
                    </div>
                    <!-- DESTINATION TYPE END -->
                    <!-- DESTINATION CLUSTER -->
                    <div class="col-xs-4" *ngIf="policyForm.get('general.destination.type').value === CLUSTER">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.destinationCluster.self' | translate"
                        [fieldClass]="'col-xs-12'"
                        [errorClass]=""
                        [required]="true">
                        <dlm-select-field
                          qe-attr="policy-destination-cluster"
                          formField
                          formControlName="cluster"
                          [options]="destinationClusters"
                          [value]="destinationCluster">
                        </dlm-select-field>
                      </dlm-form-field>
                    </div>
                    <!-- DESTINATION CLUSTER END -->
                    <!-- DESTINATION CLOUD ACCOUNT -->
                    <div class="col-xs-4" *ngIf="policyForm.get('general.destination.type').value === S3">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.s3.account' | translate"
                        [required]="true"
                        [fieldClass]="'col-xs-12'"
                        [errorClass]="">
                        <dlm-select-field
                          qe-attr="destination-cloud-account"
                          formField
                          formControlName="cloudAccount"
                          [options]="destinationCloudAccounts"
                          [value]="destinationCloudAccount">
                        </dlm-select-field>
                      </dlm-form-field>
                    </div>
                    <!-- DESTINATION CLOUD ACCOUNT END -->
                    <!-- DESTINATION S3 ENDPOINT -->
                    <div class="col-xs-4" *ngIf="policyForm.get('general.destination.cloudAccount').value && policyForm.get('general.destination.type').value === S3">
                      <dlm-form-field
                        [label]="'page.policies.form.fields.s3.endpoint' | translate"
                        [errorClass]="'col-xs-12'"
                        [fieldClass]="'col-xs-12'"
                        [required]="true">
                        <div class="input-group">
                          <div class="input-group-addon">{{S3}}</div>
                          <input
                            type="text"
                            class="form-control"
                            qe-attr="destinationS3endpoint"
                            formField
                            formControlName="s3endpoint"/>
                        </div>
                      </dlm-form-field>
                      <button type="button" class="btn btn-success pull-right">{{"page.policies.form.validateBtn" | translate}}</button>
                    </div>
                    <!-- DESTINATION S3 ENDPOINT END -->
                  </div>
                </div>
                </fieldset>
              </div>
              <!-- DESTINATION END -->
            </div>
          </fieldset>
        </div>
      </div>

      <!-- HDFS FILE BROWSER -->
      <div class="row" *ngIf="isHDFSPolicy() && sourceCluster">
        <div class="form-section col-xs-12">
          <div class="form-section-title actionable" (click)="toggleSection('directories')">
            {{'page.policies.form.sections.directories' | translate}}
            <div class="pull-right">
              <i class="fa text-primary" [ngClass]="{'fa-chevron-down': sectionCollapsedMap.directories, 'fa-chevron-up': !sectionCollapsedMap.directories}"></i>
            </div>
            <div class="clearfix"></div>
          </div>
          <fieldset [collapse]="sectionCollapsedMap.directories">
            <div class="row">
              <div class="col-xs-12">
                <dlm-form-field [label]="'page.policies.form.fields.directories' | translate">
                  <input type="text" formField class="form-control" formControlName="directories" [(ngModel)]="selectedHdfsPath"/>
                  <dlm-field-error *ngIf="policyForm.get('directories').hasError('isFile')">
                    {{'forms.validation_errors.not_directory' | translate:directoryField}}
                  </dlm-field-error>
                  <dlm-field-error *ngIf="policyForm.get('directories').hasError('notExist')">
                    {{'forms.validation_errors.not_exist_directory' | translate:directoryField}}
                  </dlm-field-error>
                </dlm-form-field>
                <div class="hdfs-browser-container">
                  <dlm-hdfs-browser
                    [rootPath]="hdfsRootPath"
                    [clusterId]="sourceCluster"
                    (select)="handleHdfsPathChange($event)"
                  ></dlm-hdfs-browser>
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
      <!-- HDFS FILE BROWSER END -->

      <!-- HIVE DB VIEWER -->
      <div class="row" *ngIf="isHivePolicy() && sourceCluster">
        <div class="form-section col-xs-12">
          <div class="form-section-title actionable" (click)="toggleSection('database')">
            {{'page.policies.form.sections.database' | translate}}
            <div class="pull-right">
              <i class="fa text-primary" [ngClass]="{'fa-chevron-down': sectionCollapsedMap.database, 'fa-chevron-up': !sectionCollapsedMap.database}"></i>
            </div>
            <div class="clearfix"></div>
          </div>
          <fieldset [collapse]="sectionCollapsedMap.database">
            <div class="form-group">
              <div class="row flex-center">
                <div class="col-xs-8">
                  <span class="text-muted">
                    <span>
                      {{'page.policies.form.selected' | translate}}: {{policyForm.value.databases}}
                    </span>
                  </span>
                </div>
                <div class="col-xs-4">
                  <dlm-search-input
                    qe-attr="policy-database-search-filter"
                    (valueChange)="handleSearchChange($event)"
                    [value]="databaseSearch$ | async">
                  </dlm-search-input>
                </div>
              </div>
              <dlm-progress-container [progressState]="databaseRequest$ | async">
                <dlm-hive-browser
                  formControlName="databases"
                  [tablesLoadingMap]="databaseTablesLoadingMap"
                  [databases]="sourceDatabases$ | async"
                  [readonly]="false"
                  (databaseTablesCollapsed)="onDatabaseTablesCollapsed($event)"
                  ></dlm-hive-browser>
              </dlm-progress-container>
            </div>
          </fieldset>
        </div>
      </div>
      <!-- HIVE DB VIEWER END -->

      <div class="row">
        <div class="form-section col-xs-12">
          <div class="form-section-title actionable" (click)="toggleSection('job')">
            {{'page.policies.form.sections.job' | translate}}
            <div class="pull-right">
              <i class="fa text-primary" [ngClass]="{'fa-chevron-down': sectionCollapsedMap.job, 'fa-chevron-up': !sectionCollapsedMap.job}"></i>
            </div>
            <div class="clearfix"></div>
          </div>
          <fieldset [collapse]="sectionCollapsedMap.job" formGroupName="job">
            <div class="schedule-group">
              <div class="row new-row">
                <div class="col col-xs-12">
                  <div class="row">
                    <div class="col-xs-12">
                      <label>{{'page.policies.form.fields.start.self' | translate}}</label>
                    </div>
                  </div>
                  <!-- START MODE -->
                  <div class="row">
                    <div class="col-xs-6">
                      <dlm-radio-button
                        qe-attr="policy-start-schedule"
                        [items]="startOptions"
                        formControlName="start"
                        [selectedValue]="selectedStart"
                        (change)="handleStartChange($event)">
                      </dlm-radio-button>
                    </div>
                  </div>
                  <!-- START MODE END -->

                  <div class="row">
                    <div class="col col-xs-12">
                      <dlm-field-label [required]="true">
                        {{'page.policies.form.fields.repeat' | translate}}
                      </dlm-field-label>
                    </div>
                  </div>

                  <div class="row">
                    <!-- REPEAT MODE -->
                    <div class="col col-xs-2">
                      <dlm-select-field
                        qe-attr="policy-repeat-mode"
                        formField
                        formControlName="repeatMode"
                        [options]="repeatOptions"
                        [value]="repeatOption">
                      </dlm-select-field>
                    </div>
                    <!-- REPEAT MODE END -->

                    <!-- FREQUENCY -->
                    <div *ngIf="repeatOption === policyRepeatModes.EVERY" class="col col-xs-1"
                         [class.has-error]="policyForm.get('job.frequency').touched && policyForm.get('job.frequency').invalid">
                      <input
                        type="text"
                        qe-attr="policy-frequency"
                        class="form-control"
                        placeholder="Freq"
                        formField
                        formControlName="frequency" />
                    </div>
                    <!-- FREQUENCY END -->

                    <!-- REPEAT UNITS -->
                    <div *ngIf="repeatOption === policyRepeatModes.EVERY" class="col col-xs-2">
                      <dlm-select-field
                        qe-attr="policy-unit"
                        formField
                        formControlName="unit"
                        [options]="units"
                        [value]="unit">
                      </dlm-select-field>
                    </div>
                    <!-- REPEAT UNITS END -->

                    <!-- DAYS OF THE WEEK -->
                    <div *ngIf="repeatOption === policyRepeatModes.EVERY && unit === policyTimeUnits.WEEKS"
                         class="col col-xs-7">
                      <div class="row">
                        <div class="col col-xs-1 text-center" style="margin-top: 10px">
                          <span>&nbsp;on&nbsp;</span>
                        </div>
                        <div class="col col-xs-11">
                          <dlm-radio-button
                            qe-attr="policy-selected-days"
                            [items]="dayOptions"
                            formControlName="day"
                            [selectedValue]="selectedDay"
                            [type]="'buttons'"
                            [disabled]="startOption === policyStart.START_NOW"
                            (change)="handleDayChange($event)">
                          </dlm-radio-button>
                        </div>
                      </div>
                    </div>
                    <!-- DAYS OF THE WEEK END -->

                  </div>
                  <div class="row">
                    <!-- FREQUENCY ERRORS -->
                    <div class="col col-xs-5 col-xs-offset-2">
                      <div *ngIf="policyForm.get('job.frequency').touched">
                        <dlm-field-error
                          *ngIf="policyForm.get('job.frequency').hasError('required')">
                          {{'forms.validation_errors.required' | translate:freqRequired}}
                        </dlm-field-error>
                        <dlm-field-error
                          *ngIf="policyForm.get('job.frequency').hasError('freqValidator')">
                          {{'forms.validation_errors.freqValidator' | translate:freqLimit}}
                        </dlm-field-error>
                        <dlm-field-error
                          *ngIf="policyForm.get('job.frequency').hasError('integerValidator')">
                          {{'forms.validation_errors.integerValidator' | translate:freqLimit}}
                        </dlm-field-error>
                      </div>
                      <dlm-field-error
                        *ngIf="policyForm.get('job.frequency').touched && policyForm.get('job.frequency').hasError('freqValidator')">
                        {{'forms.validation_errors.freqValidator' | translate:freqLimit}}
                      </dlm-field-error>
                    </div>
                    <!-- FREQUENCY ERRORS END -->
                  </div>
                </div>
              </div>
              <div class="row new-row">
                <div class="col-xs-3" formGroupName="startTime">
                  <!-- START DATE -->
                  <div class="date-time-group">
                    <div class="date-control">
                      <label>{{'page.policies.form.fields.start_date' | translate}}</label>
                      <my-date-picker
                        qe-attr="policy-start-date"
                        selectionTxtFontSize="12"
                        [selDate]="policyForm.value.job.startTime.date"
                        [placeholder]="'page.policies.form.fields.date_format' | translate"
                        [options]="datePickerOptions"
                        [disabled]="startOption === policyStart.START_NOW"
                        (inputFieldChanged)="handleDateInputChange($event, 'startTime')"
                        (dateChanged)="handleDateChange($event, 'startTime')">
                      </my-date-picker>
                      <dlm-field-error
                        *ngIf="policyForm.get('job.startTime.date').hasError('invalidDate')">
                        {{'forms.validation_errors.invalid_date' | translate:startTimeDateField}}
                      </dlm-field-error>
                    </div>
                  </div>
                  <!-- START DATE END -->
                </div>
                <div class="col-xs-3" formGroupName="endTime">
                  <!-- END DATE -->
                  <div class="date-time-group">
                    <div class="date-control">
                      <label>{{'page.policies.form.fields.end_date' | translate}}</label>
                      <my-date-picker
                        qe-attr="policy-end-time"
                        [selDate]="policyForm.value.job.endTime.date"
                        [placeholder]="'page.policies.form.fields.date_format' | translate"
                        (dateChanged)="handleDateChange($event, 'endTime')"
                        (inputFieldChanged)="handleDateInputChange($event, 'endTime')"
                        [options]="datePickerOptions">
                      </my-date-picker>
                      <dlm-field-error
                        *ngIf="policyForm.get('job.endTime.date').hasError('invalidDate')">
                        {{'forms.validation_errors.invalid_date' | translate:endTimeDateField}}
                      </dlm-field-error>
                    </div>
                  </div>
                  <!-- END DATE END -->
                </div>
              </div>
              <div class="row new-row">
                <!-- START TIME -->
                <div class="time-field" formGroupName="startTime">
                  <label>{{'page.policies.form.fields.start_time' | translate}}</label>
                  <timepicker
                    qe-attr="policy-start-time"
                    formField formControlName="time"
                    [showMeridian]="false"
                    [showSpinners]="false"
                    [readonlyInput]="startOption === policyStart.START_NOW">
                  </timepicker>
                </div>
                <div class="timezone-field">
                  <label>
                    {{'page.policies.form.fields.timezone' | translate}}
                    <dlm-help-link [iconHint]="'page.policies.form.fields.timezone_hint' | translate" [placement]="'right'"></dlm-help-link>
                  </label>
                  <div class="value" [tooltip]="userTimezone" [placement]="'bottom'">
                    {{userTimezone | truncate:40}}
                  </div>
                </div>
                <!-- START TIME END -->
              </div>
              <div class="new-row">
                <dlm-field-error *ngIf="policyForm.get('job.startTime.time').hasError('lessThanCurrent')">
                  {{'forms.validation_errors.time_less_than_current' | translate}}
                </dlm-field-error>
                <dlm-field-error *ngIf="policyForm.get('job.startTime.time').hasError('greaterThanEndTime')">
                  {{'forms.validation_errors.greaterThanEndTime' | translate}}
                </dlm-field-error>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <div class="row">
        <div class="form-section col-xs-12">
          <div class="form-section-title actionable" (click)="toggleSection('advanced')">
            {{'page.policies.form.sections.advanced' | translate}}
            <div class="pull-right">
              <i class="fa text-primary" [ngClass]="{'fa-chevron-down': sectionCollapsedMap.advanced, 'fa-chevron-up': !sectionCollapsedMap.advanced}"></i>
            </div>
            <div class="clearfix"></div>
          </div>
          <fieldset [collapse]="sectionCollapsedMap.advanced" formGroupName="advanced">
            <!-- QUEUE NAME -->
            <dlm-form-field
              [label]="'page.policies.form.fields.queue_name' | translate">
              <dlm-select-field qe-attr="yarn-queue-name" formField formControlName="queue_name" [options]="yarnQueueList">
              </dlm-select-field>
            </dlm-form-field>
            <!-- QUEUE NAME END -->

            <!-- MAX BANDWIDTH -->
            <dlm-form-field
              [label]="'page.policies.form.fields.max_bandwidth' | translate">
              <div class="input-group">
                <input type="text" class="form-control" formField formControlName="max_bandwidth"/>
                <span class="input-group-addon">{{'page.policies.form.fields.bandwidth_unit' | translate}}</span>
              </div>
            </dlm-form-field>
            <!-- MAX BANDWIDTH END -->
            <div class="row">
              <div class="col col-xs-6">
                <div *ngIf="policyForm.get('advanced.max_bandwidth').touched">
                  <dlm-field-error
                    *ngIf="policyForm.get('advanced.max_bandwidth').hasError('integerValidator')">
                    {{'forms.validation_errors.integerValidator' | translate:maxBandwidthField}}
                  </dlm-field-error>
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <div class="row">
        <div class="form-footer col-xs-12">
          <div class="footer-controls pull-right">
            <button qe-attr="policy-cancel" type="button" class="btn btn-default" (click)="cancel()">
              {{'common.cancel' | translate}}
            </button>
            <button qe-attr="policy-submit" class="btn btn-success" type="submit" [disabled]="!policyForm.valid">
              {{'common.review' | translate}}
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
