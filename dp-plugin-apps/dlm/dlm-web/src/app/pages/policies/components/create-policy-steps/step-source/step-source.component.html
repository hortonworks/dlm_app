<!--
  ~ Copyright  (c) 2016-2017, Hortonworks Inc.  All rights reserved.
  ~
  ~ Except as expressly permitted in a written agreement between you or your company
  ~ and Hortonworks, Inc. or an authorized affiliate or partner thereof, any use,
  ~ reproduction, modification, redistribution, sharing, lending or other exploitation
  ~ of all or any part of the contents of this software is strictly prohibited.
  -->

<div class="form-container">
  <form class="basic-form policy-form" [formGroup]="form">
    <div class="container-fluid">
      <div class="row">
        <div class="form-section col-xs-12">
          <div class="form-group">
            <!-- SOURCE -->
            <fieldset formGroupName="source">
              <div class="col-xs-12">
                <div class="row">
                  <!-- SOURCE TYPE -->
                  <div class="col-xs-4">
                    <dlm-form-field
                      [label]="'page.policies.form.fields.source_type' | translate"
                      [fieldClass]="'col-xs-12'"
                      [errorClass]=""
                      [required]="true">
                      <dlm-select-field
                        qe-attr="policy-source-type"
                        formField
                        formControlName="type"
                        [options]="sourceTypes"
                        [value]="sourceType">
                      </dlm-select-field>
                    </dlm-form-field>
                  </div>
                  <!-- SOURCE TYPE END -->
                  <!-- SOURCE CLUSTER -->
                  <div class="col-xs-4" *ngIf="form.get('source.type').value === SOURCE_TYPES.CLUSTER">
                    <dlm-form-field
                      [label]="'page.policies.form.fields.sourceCluster.self' | translate"
                      [fieldClass]="'col-xs-12'"
                      [errorClass]=""
                      [required]="true">
                      <dlm-select-field
                        qe-attr="policy-source-cluster"
                        formField
                        formControlName="cluster"
                        [options]="sourceClusters"
                        [value]="sourceCluster">
                      </dlm-select-field>
                    </dlm-form-field>
                  </div>
                  <!-- SOURCE CLUSTER END -->
                  <!-- SOURCE CLOUD ACCOUNT -->
                  <div class="col-xs-4"
                       *ngIf="form.get('source.type').value === SOURCE_TYPES.S3">
                    <dlm-form-field
                      [label]="'page.policies.form.fields.s3.account' | translate"
                      [required]="true"
                      [fieldClass]="'col-xs-12'"
                      [errorClass]="">
                      <dlm-select-field
                        qe-attr="source-cloud-account"
                        formField
                        formControlName="cloudAccount"
                        [options]="sourceCloudAccounts"
                        [value]="sourceCloudAccount">
                      </dlm-select-field>
                    </dlm-form-field>
                  </div>
                  <!-- SOURCE CLOUD ACCOUNT END -->
                  <!-- SOURCE S3 ENDPOINT -->
                  <div class="col-xs-4" *ngIf="form.get('source.cloudAccount').value && form.get('source.type').value === SOURCE_TYPES.S3">
                    <dlm-form-field
                      [label]="'page.policies.form.fields.s3.endpoint' | translate"
                      [errorClass]="'col-xs-12'"
                      [fieldClass]="'col-xs-12'"
                      [required]="true">
                      <div class="input-group">
                        <div class="input-group-addon">{{SOURCE_TYPES_LABELS[SOURCE_TYPES.S3]}}://</div>
                        <input
                          type="text"
                          class="form-control"
                          qe-attr="source-S3-endpoint"
                          formField
                          formControlName="s3endpoint"/>
                      </div>
                    </dlm-form-field>
                    <button type="button" class="btn btn-success pull-right">{{"page.policies.form.validateBtn" | translate}}</button>
                  </div>
                  <!-- SOURCE S3 ENDPOINT END -->
                </div>
              </div>

              <!-- HDFS FILE BROWSER -->
              <div class="row" *ngIf="isHDFSPolicy() && sourceCluster">
                <div class="form-section col-xs-12">
                  <div class="form-section-title">
                    {{'page.policies.form.sections.directories' | translate}}
                  </div>
                  <fieldset>
                    <div class="row">
                      <div class="col-xs-12">
                        <dlm-form-field [label]="'page.policies.form.fields.directories' | translate">
                          <input type="text" formField class="form-control" formControlName="directories" [(ngModel)]="selectedHdfsPath"/>
                          <dlm-field-error *ngIf="form.get('source.directories').hasError('isFile')">
                            {{'forms.validation_errors.not_directory' | translate:directoryField}}
                          </dlm-field-error>
                          <dlm-field-error *ngIf="form.get('source.directories').hasError('notExist')">
                            {{'forms.validation_errors.not_exist_directory' | translate:directoryField}}
                          </dlm-field-error>
                        </dlm-form-field>
                        <div class="hdfs-browser-container">
                          <dlm-hdfs-browser
                            [rootPath]="hdfsRootPath"
                            [clusterId]="sourceCluster"
                            (select)="handleHdfsPathChange($event)"
                          ></dlm-hdfs-browser>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                </div>
              </div>
              <!-- HDFS FILE BROWSER END -->

              <!-- HIVE DB VIEWER -->
              <div class="row" *ngIf="isHivePolicy() && sourceCluster">
                <div class="form-section col-xs-12">
                  <div class="form-section-title">
                    {{'page.policies.form.sections.database' | translate}}
                  </div>
                  <fieldset>
                    <div class="form-group">
                      <div class="row flex-center">
                        <div class="col-xs-8">
                  <span class="text-muted">
                    <span>
                      {{'page.policies.form.selected' | translate}}: {{form.value.source.databases}}
                    </span>
                  </span>
                        </div>
                        <div class="col-xs-4">
                          <dlm-search-input
                            qe-attr="policy-database-search-filter"
                            (valueChange)="handleSearchChange($event)"
                            [value]="databaseSearch$ | async">
                          </dlm-search-input>
                        </div>
                      </div>
                      <dlm-progress-container [progressState]="databaseRequest$ | async">
                        <dlm-hive-browser
                          formControlName="databases"
                          [tablesLoadingMap]="databaseTablesLoadingMap"
                          [databases]="sourceDatabases$ | async"
                          [readonly]="false"
                          (databaseTablesCollapsed)="onDatabaseTablesCollapsed($event)"
                        ></dlm-hive-browser>
                      </dlm-progress-container>
                    </div>
                  </fieldset>
                </div>
              </div>
              <!-- HIVE DB VIEWER END -->

            </fieldset>
            <!-- SOURCE END -->
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
